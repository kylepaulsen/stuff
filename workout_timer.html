<html>
<head>
    <title>Workout Timer</title>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, user-scalable=no'>
    <style>
    body {
        margin: 0;
        padding: 6px 0 6px 6px;
    }
    #workoutContainer {
        display: none;
        position: absolute;
        width: 80%;
        height: 80%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 1px solid #000000;
        background: #ffffff;
        padding: 20px;
    }
    #overlay {
        display: none;
        background: rgba(0, 0, 0, 0.5);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }
    #currentExerciseName {
        text-align: center;
        font-size: 40px;
    }
    @media (max-width: 600px) {
        #currentExerciseName {
            font-size: 26px;
        }
    }
    #stopWorkoutBtn {
        margin-top: 0;
    }
    #loadWorkoutSelect {
        margin-top: 10px;
    }
    #screenLockVid {
        display: none;
    }
    .sit {
        flex: 0 1 auto;
    }
    .sit2 {
        flex: 0 1 144px;
    }
    .fill {
        flex: 1 1 auto;
        padding: 0 6px;
    }
    .vflex {
        display: flex;
        flex-direction: column;
    }
    .workoutContainerTop {
        flex: 0 0 20%;
    }
    .workoutContainerMiddle {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 160px;
        flex: 1 1 70%;
    }
    .workoutContainerBottom {
        text-align: center;
        flex: 0 0 10%;
    }
    .nameInput {
        width: 100%;
    }
    .btn {
        cursor: pointer;
        min-width: 120px;
        height: 50px;
        margin-top: 20px;
    }
    .exercise {
        margin-top: 10px;
        display: flex;
        width: 100%;
    }
    .secondsInput {
        width: 50px;
    }
    </style>
</head>
<body>
    Workout Name: <input id='workoutNameInput' value='7 Minute Workout'>
    <div id='exercises'></div>
    <div style='margin-top: 20px;'>Rest Seconds: <input id='restSecondsInput' type='number' value='10'></div>
    <button id='addExerBtn' class='btn'>Add Exercise</button>
    <button id='saveWorkoutBtn' class='btn'>Save Workout</button>
    <button id='deleteWorkoutBtn' class='btn'>Delete Workout</button>
    <select id='loadWorkoutSelect'></select><br>
    <button id='startWorkoutBtn' class='btn'>Start Workout</button>
    <br><br>
    Voice: <select id='voiceSelect'></select>
    <div id='overlay'></div>
    <div id='workoutContainer'>
        <div class='vflex'>
            <div class='workoutContainerTop'>
                <div id='currentExerciseName'></div>
            </div>
            <div class='workoutContainerMiddle'>
                <div id='currentExerciseTime'></div>
            </div>
            <div class='workoutContainerBottom'>
                <button id='stopWorkoutBtn' class='btn'>Stop Workout</button>
            </div>
        </div>
    </div>
    <video id='screenLockVid' width='1' loop muted playsinline>
        <source
            src='data:video/mp4;base64,AAAAGGZ0eXBtcDQyAAAAAG1wNDFpc29tAAAAJ3V1aWRcpwj7Mo5CBahhZQ7KCpWWAAAACzYuMi4wOTIwMC4wAAABVm1kYXQAAAAAAAAAEAAAAAIJEAAAADMGBS8C+GFQ/HBBcrcySPOnKj00TWljcm9zb2Z0IEguMjY0IEVuY29kZXIgVjEuNS4zAIAAAADnBgXjy7ITkphzQ9qopsdCmDVs9XNyYzozIGg6NjQgdzo2NCBmcHM6MS4wMDAgcGY6NjYgbHZsOjEgYjowIGJxcDozIGdvcDozIGlkcjozIHNsYzoxIGNtcDowIHJjOjEgcXA6MjYgcmF0ZToxMDAwMDAgcGVhazowIGJ1ZmY6Mzc1MDAgcmVmOjIgc3JjaDozMiBhc3JjaDoxIHN1YnA6MSBwYXI6NiAzIDMgcm5kOjAgY2FiYWM6MCBscDoyIGN0bnQ6MCBhdWQ6MSBsYXQ6MCB3cms6NCB2dWk6MSBseXI6MSA8PACAAAAAGmWIgEv///D0UAAQI/eK331itddddddddddeAAACrW1vb3YAAABsbXZoZAAAAADVNz8p1Tc/KQAAA+gAAAPoAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAH1dHJhawAAAFx0a2hkAAAAAdU3PynVNz8pAAAAAQAAAAAAAAPoAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAABAAAAAQAAAAAABkW1kaWEAAAAgbWRoZAAAAADVNz8p1Tc/KQAAA+gAAAPoVcQAAAAAAC1oZGxyAAAAAAAAAAB2aWRlAAAAAAAAAAAAAAAAVmlkZW9IYW5kbGVyAAAAATxtaW5mAAAAFHZtaGQAAAABAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAAD8c3RibAAAAJRzdHNkAAAAAAAAAAEAAACEYXZjMQAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAABAAEAASAAAAEgAAAAAAAAAAQpBVkMgQ29kaW5nAAAAAAAAAAAAAAAAAAAAAAAAAAAAABj//wAAAC5hdmNDAULQC//hABdnQtALlbEJoQAAAwABAAADAAINoIhG4AEABGjKjyAAAAAYc3R0cwAAAAAAAAABAAAAAQAAA+gAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAGHN0c3oAAAAAAAAAAAAAAAEAAAFGAAAAFHN0Y28AAAAAAAAAAQAAAE8AAABEdWR0YQAAADRtZXRhAAAAAAAAACBoZGxyAAAAAAAAAABtZGlyAAAAAAAAAAAAAAAAAAAACGlsc3QAAAAIWHRyYQ=='
            type='video/mp4'>
    </video>

    <script>
    (function() {
        const ui = {};

        let voices = [];

        function checkForVoices() {
            if (voices.length === 0) {
                voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    voices.forEach(function(v, i) {
                        const opt = document.createElement('option');
                        const name = `${v.name} (${v.lang})`;
                        opt.innerHTML = name;
                        if (name.toLowerCase().search(/en[\-_ ]us/i) > -1) {
                            opt.setAttribute('selected', 'selected');
                        }
                        ui.voiceSelect.appendChild(opt);
                    });
                    clearInterval(checkForVoicesIntervalId);
                }
            }
        }
        const checkForVoicesIntervalId = setInterval(checkForVoices, 100);

        const allIds = document.querySelectorAll('[id]');
        for (let x = 0; x < allIds.length; x++) {
            ui[allIds[x].id] = allIds[x];
        }

        const exerciseTemplate = `
        <div class='sit'>Name: </div>
        <div class='fill'><input class='nameInput' class='nameInput' value='{name}'></div>
        <div class='sit2'>Time: <input class='secondsInput' value='{seconds}' type='number'>
        <button class='removeExerciseBtn'>Ã—</button></div>
        `;

        let allSavedWorkouts = JSON.parse(localStorage.savedWorkouts || '[]');
        function populateLoadDropdown() {
            let loadDropdownHTML = '<option value="-1">Load Workout...</option>';
            allSavedWorkouts.forEach(function(workout, idx) {
                loadDropdownHTML += `<option value='${idx}'>${workout.name}</option>`;
            });
            ui.loadWorkoutSelect.innerHTML = loadDropdownHTML;
        }
        populateLoadDropdown();

        function loadWorkout(e) {
            const workoutToLoad = allSavedWorkouts[ui.loadWorkoutSelect.selectedIndex - 1];
            ui.workoutNameInput.value = workoutToLoad.name;
            ui.restSecondsInput.value = workoutToLoad.restSeconds;
            ui.exercises.innerHTML = '';
            workoutToLoad.exercises.forEach(function(exercise) {
                addExercise(exercise.name, exercise.seconds);
            });
            ui.loadWorkoutSelect.value = '-1';
        }

        function parseWorkoutObject() {
            const exercises = parseExercises().filter(function(exercise) {
                return exercise.name !== 'Rest' && exercise.name !== 'Get Ready';
            });
            return {
                name: ui.workoutNameInput.value,
                restSeconds: ui.restSecondsInput.value,
                exercises: exercises
            };
        }

        function deleteWorkout() {
             const exercisesObjJson = JSON.stringify(parseWorkoutObject());
             allSavedWorkouts = allSavedWorkouts.filter(function(workout) {
                return JSON.stringify(workout) !== exercisesObjJson;
             });
             localStorage.savedWorkouts = JSON.stringify(allSavedWorkouts);
             ui.exercises.innerHTML = '';
             ui.workoutNameInput.value = '';
             ui.restSecondsInput.value = '10';
             populateLoadDropdown();
             addExercise();
        }

        function saveWorkout() {
            allSavedWorkouts.push(parseWorkoutObject());
            localStorage.savedWorkouts = JSON.stringify(allSavedWorkouts);
            populateLoadDropdown();
        }

        function addExercise(name, seconds) {
            const div = document.createElement('div');
            div.className = 'exercise';
            div.innerHTML = exerciseTemplate.replace('{name}', name.replace(/'/g, '&#39;') || '')
                .replace('{seconds}', seconds || 30);

            ui.exercises.appendChild(div);
        }

        let lastMsg;
        function primeSpeechSynthesis() {
            say('z', 2, true);
        }

        function say(msg, speed, mute) {
            if (msg !== lastMsg) {
                lastMsg = msg;
                let speakIt = new SpeechSynthesisUtterance(msg);
                speakIt.rate = speed || 1;
                speakIt.voice = voices[ui.voiceSelect.selectedIndex];
                speakIt.pitch = 1;
                if (mute) {
                    speakIt.volume = 0;
                }
                window.speechSynthesis.speak(speakIt);
            }
        }

        let exercises = [];
        let currentExerciseIdx = 0;
        let timerTimestamp;
        let timerLength;
        function updateTime() {
            const time = timerLength - Math.floor((Date.now() - timerTimestamp) / 1000);
            if (time < 0) {
                nextExercise();
                return;
            }
            ui.currentExerciseTime.textContent = time;

            const isExercise = currentExerciseIdx % 2 === 1;
            if (time === Math.floor(exercises[currentExerciseIdx].seconds / 2) && isExercise &&
                exercises[currentExerciseIdx].seconds > 7) {
                say('Halfway done!');
            } else if (time === 4) {
                primeSpeechSynthesis();
            } else if (time < 4 && time > 0) {
                say(time, 1.5);
            } else if (time === 0) {
                if (currentExerciseIdx === 0) {
                    say('Start Workout');
                } else {
                    if (currentExerciseIdx >= exercises.length - 1) {
                        say('Workout complete!');
                        stopWorkout();
                    } else if (isExercise) {
                        say(`Now rest! Up next, ${exercises[currentExerciseIdx + 2].name}`);
                    } else {
                        say('Go!');
                    }
                }
            }
        }

        const workerFunc = function() {
            const tickRate = 100;

            const tick = function() {
                postMessage('tick');
            };

            setInterval(tick, tickRate);
        };

        const worker = new Worker((function(func) {
            const src = '"use strict"; (' + func.toString() + ')();';
            const blob = new Blob([src], {type: 'text/javascript'});
            return window.URL.createObjectURL(blob);
        })(workerFunc));

        function nextExercise() {
            currentExerciseIdx++;
            const currentExercise = exercises[currentExerciseIdx];
            let nextUp = '';
            if (currentExercise.name === 'Rest' || currentExercise.name === 'Get Ready') {
                nextUp = ` (Next up: ${exercises[currentExerciseIdx + 1].name})`;
            }
            if (currentExercise) {
                timerTimestamp = Date.now();
                timerLength = currentExercise.seconds;
                ui.currentExerciseName.textContent = currentExercise.name + nextUp;
                ui.currentExerciseTime.textContent = currentExercise.seconds;
            }
        }

        function getNumber(str, defaultNum) {
            let num = parseInt(str);
            if (isNaN(num)) {
                return defaultNum;
            }
            return num;
        }

        function parseExercises() {
            const exercises = [{name: 'Get Ready', seconds: 6}];
            const restSeconds = getNumber(ui.restSecondsInput.value, 10);
            const exerciseElements = ui.exercises.children;
            for (let x = 0; x < exerciseElements.length; x++) {
                if (x > 0) {
                    exercises.push({name: 'Rest', seconds: restSeconds});
                }
                const exerciseEl = exerciseElements[x];
                const nameEl = exerciseEl.querySelector('.nameInput');
                const secondsEl = exerciseEl.querySelector('.secondsInput');
                let seconds = getNumber(secondsEl.value, 30);
                exercises.push({name: nameEl.value || 'Untitled', seconds: seconds});
            }
            return exercises;
        }

        function startWorkout() {
            document.body.scrollTop = 0;
            ui.workoutContainer.style.display = 'block';
            ui.overlay.style.display = 'block';

            exercises = parseExercises();

            currentExerciseIdx = -1;
            nextExercise();

            ui.screenLockVid.play();
            say(`First up, ${exercises[1].name}`);
            worker.addEventListener('message', updateTime);
        }

        function stopWorkout() {
            ui.screenLockVid.pause();
            ui.workoutContainer.style.display = 'none';
            ui.overlay.style.display = 'none';
            worker.removeEventListener('message', updateTime);

        }

        window.addEventListener('click', function(e) {
            const target = e.target;
            if (target.className === 'removeExerciseBtn') {
                const exercise = target.parentNode.parentNode;
                ui.exercises.removeChild(exercise);
            }
        })

        ui.addExerBtn.addEventListener('click', function() {
            addExercise('', 30);
        });
        ui.startWorkoutBtn.addEventListener('click', startWorkout);
        ui.stopWorkoutBtn.addEventListener('click', stopWorkout);
        ui.loadWorkoutSelect.addEventListener('change', loadWorkout);
        ui.saveWorkoutBtn.addEventListener('click', saveWorkout);
        ui.deleteWorkoutBtn.addEventListener('click', deleteWorkout);

        addExercise('Jumping Jacks', 30);
        addExercise('Wall Sit', 30);
        addExercise('Push ups', 30);
        addExercise('Crunches', 30);
        addExercise('Step ups', 30);
        addExercise('Squats', 30);
        addExercise('Triceps Dips', 30);
        addExercise('Plank', 30);
        addExercise('High Knees Running In Place', 30);
        addExercise('Lunge', 30);
        addExercise('Push up and Rotation', 30);
        addExercise('Side Plank', 30);
    })();
    </script>
</body>
</html>
