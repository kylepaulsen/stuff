<html>
<head>
    <title>Workout Timer</title>
    <style>
    #workoutContainer {
        display: none;
        position: absolute;
        width: 80%;
        height: 80%;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        border: 1px solid #000000;
        background: #ffffff;
        padding: 20px;
    }
    #overlay {
        display: none;
        background: rgba(0, 0, 0, 0.5);
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }
    #currentExerciseName {
        text-align: center;
        font-size: 40px;
    }
    #stopWorkoutBtn {
        margin-top: 0;
    }
    .vflex {
        display: flex;
        flex-direction: column;
    }
    .workoutContainerTop {
        flex: 0 0 10%;
    }
    .workoutContainerMiddle {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 160px;
        flex: 1 1 80%;
    }
    .workoutContainerBottom {
        text-align: center;
        flex: 0 0 10%;
    }
    .nameInput {
        width: 300px;
    }
    .btn {
        cursor: pointer;
        min-width: 120px;
        height: 50px;
        margin-top: 20px;
    }
    .exercise {
        margin-top: 10px;
    }
    .secondsInput {
        width: 50px;
    }
    </style>
</head>
<body>
    Workout Name: <input id='workoutNameInput' value='7 Minute Workout'>
    <div id='exercises'></div>
    <div style='margin-top: 20px;'>Rest Seconds: <input id='restSecondsInput' type='number' value='10'></div>
    <button id='addExerBtn' class='btn'>Add Exercise</button>
    <button id='saveWorkoutBtn' class='btn'>Save Workout</button>
    <button id='deleteWorkoutBtn' class='btn'>Delete Workout</button>
    <select id='loadWorkoutSelect'></select><br>
    <button id='startWorkoutBtn' class='btn'>Start Workout</button>
    Voice: <select id='voiceSelect'></select>
    <div id='overlay'></div>
    <div id='workoutContainer'>
        <div class='vflex'>
            <div class='workoutContainerTop'>
                <div id='currentExerciseName'></div>
            </div>
            <div class='workoutContainerMiddle'>
                <div id='currentExerciseTime'></div>
            </div>
            <div class='workoutContainerBottom'>
                <button id='stopWorkoutBtn' class='btn'>Stop Workout</button>
            </div>
        </div>
    </div>

    <script>
        const ui = {};
        const $ = document.querySelector.bind(document);

        let currentVoiceIdx = 0;
        let voices = [];
        speechSynthesis.onvoiceschanged = function() {
            if (voices.length === 0) {
                voices = speechSynthesis.getVoices();
                voices.forEach(function(v) {
                    const opt = document.createElement('option');
                    opt.innerHTML = v.name;
                    ui.voiceSelect.appendChild(opt);
                });
            }
        };

        const allIds = document.querySelectorAll('[id]');
        for (let x = 0; x < allIds.length; x++) {
            ui[allIds[x].id] = allIds[x];
        }

        const exerciseTemplate = `
        Name: <input class='nameInput' class='nameInput' value='{name}'>
        Seconds: <input class='secondsInput' value='{seconds}' type='number'>
        <button class='removeExerciseBtn'>Remove</button>
        `;

        let allSavedWorkouts = JSON.parse(localStorage.savedWorkouts || '[]');
        function populateLoadDropdown() {
            let loadDropdownHTML = '<option value="-1">Load Workout...</option>';
            allSavedWorkouts.forEach(function(workout, idx) {
                loadDropdownHTML += `<option value='${idx}'>${workout.name}</option>`;
            });
            ui.loadWorkoutSelect.innerHTML = loadDropdownHTML;
        }
        populateLoadDropdown();

        function loadWorkout(e) {
            const workoutToLoad = allSavedWorkouts[ui.loadWorkoutSelect.selectedIndex - 1];
            ui.workoutNameInput.value = workoutToLoad.name;
            ui.restSecondsInput.value = workoutToLoad.restSeconds;
            ui.exercises.innerHTML = '';
            workoutToLoad.exercises.forEach(function(exercise) {
                addExercise(exercise.name, exercise.seconds);
            });
            ui.loadWorkoutSelect.value = '-1';
        }

        function parseWorkoutObject() {
            const exercises = parseExercises().filter(function(exercise) {
                return exercise.name !== 'Rest' && exercise.name !== 'Get Ready';
            });
            return {
                name: ui.workoutNameInput.value,
                restSeconds: ui.restSecondsInput.value,
                exercises: exercises
            };
        }

        function deleteWorkout() {
             const exercisesObjJson = JSON.stringify(parseWorkoutObject());
             allSavedWorkouts = allSavedWorkouts.filter(function(workout) {
                return JSON.stringify(workout) !== exercisesObjJson;
             });
             localStorage.savedWorkouts = JSON.stringify(allSavedWorkouts);
             ui.exercises.innerHTML = '';
             ui.workoutNameInput.value = '';
             ui.restSecondsInput.value = '10';
             populateLoadDropdown();
             addExercise();
        }

        function saveWorkout() {
            allSavedWorkouts.push(parseWorkoutObject());
            localStorage.savedWorkouts = JSON.stringify(allSavedWorkouts);
            populateLoadDropdown();
        }

        function addExercise(name, seconds) {
            const div = document.createElement('div');
            div.className = 'exercise';
            div.innerHTML = exerciseTemplate.replace('{name}', name || '')
                .replace('{seconds}', seconds || 30);

            ui.exercises.appendChild(div);
        }

        let lastMsg;
        function primeSpeechSynthesis(msg) {
            if (msg !== lastMsg) {
                lastMsg = msg;
                const primeMsg = new SpeechSynthesisUtterance('a');
                primeMsg.rate = 10;
                primeMsg.volume = 0;
                window.speechSynthesis.speak(primeMsg);
            }
        }

        function say(msg, speed) {
            if (msg !== lastMsg) {
                lastMsg = msg;
                let speakIt = new SpeechSynthesisUtterance(msg);
                speakIt.rate = speed || 1;
                speakIt.voice = voices[currentVoiceIdx];
                speakIt.pitch = 1;
                window.speechSynthesis.speak(speakIt);
            }
        }

        let exercises = [];
        let currentExerciseIdx = 0;
        let timerTimestamp;
        let timerLength;
        function updateTime() {
            const time = timerLength - Math.floor((Date.now() - timerTimestamp) / 1000);
            if (time < 0) {
                nextExercise();
                return;
            }
            ui.currentExerciseTime.textContent = time;

            const isExercise = currentExerciseIdx % 2 === 1;
            if (time === Math.floor(exercises[currentExerciseIdx].seconds / 2) && isExercise) {
                say('Halfway done!');
            } else if (time === 4) {
                primeSpeechSynthesis(4);
            } else if (time < 4 && time > 0) {
                say(time, 1.5);
            } else if (time === 0) {
                if (currentExerciseIdx === 0) {
                    say('Start Workout');
                } else {
                    if (currentExerciseIdx === exercises.length - 1) {
                        say('Workout complete!');
                        stopWorkout();
                    } else if (isExercise) {
                        say('Now rest!');

                        setTimeout(function() {
                            const name = exercises[currentExerciseIdx + 1].name;
                            if (name !== 'Rest') {
                                say('Up next, ' + name);
                            }
                        }, 1000);
                    } else {
                        say('Go!');
                    }
                }
            }
        }

        const workerFunc = function() {
            const tickRate = 100;

            const tick = function() {
                postMessage('tick');
            };

            setInterval(tick, tickRate);
        };

        const worker = new Worker((function(func) {
            const src = '"use strict"; (' + func.toString() + ')();';
            const blob = new Blob([src], {type: 'text/javascript'});
            return window.URL.createObjectURL(blob);
        })(workerFunc));

        function nextExercise() {
            currentExerciseIdx++;
            const currentExercise = exercises[currentExerciseIdx];
            if (currentExercise) {
                timerTimestamp = Date.now();
                timerLength = currentExercise.seconds;
                ui.currentExerciseName.textContent = currentExercise.name;
                ui.currentExerciseTime.textContent = currentExercise.seconds;
            }
        }

        function getNumber(str, defaultNum) {
            let num = parseInt(str);
            if (isNaN(num)) {
                return defaultNum;
            }
            return num;
        }

        function parseExercises() {
            const exercises = [{name: 'Get Ready', seconds: 6}];
            const restSeconds = getNumber(ui.restSecondsInput.value, 10);
            const exerciseElements = ui.exercises.children;
            for (let x = 0; x < exerciseElements.length; x++) {
                if (x > 0) {
                    exercises.push({name: 'Rest', seconds: restSeconds});
                }
                const exerciseEl = exerciseElements[x];
                const nameEl = exerciseEl.querySelector('.nameInput');
                const secondsEl = exerciseEl.querySelector('.secondsInput');
                let seconds = getNumber(secondsEl.value, 30);
                exercises.push({name: nameEl.value || 'Untitled', seconds: seconds});
            }
            return exercises;
        }

        function startWorkout() {
            ui.workoutContainer.style.display = 'block';
            ui.overlay.style.display = 'block';

            exercises = parseExercises();

            currentExerciseIdx = -1;
            nextExercise();

            say('First up, ' + exercises[1].name);
            worker.addEventListener('message', updateTime);
        }

        function stopWorkout() {
            ui.workoutContainer.style.display = 'none';
            ui.overlay.style.display = 'none';
            worker.removeEventListener('message', updateTime);

        }

        window.addEventListener('click', function(e) {
            const target = e.target;
            if (target.className === 'removeExerciseBtn') {
                const exercise = target.parentNode;
                ui.exercises.removeChild(exercise);
            }
        })

        ui.addExerBtn.addEventListener('click', function() {
            addExercise();
        });
        ui.startWorkoutBtn.addEventListener('click', startWorkout);
        ui.stopWorkoutBtn.addEventListener('click', stopWorkout);
        ui.loadWorkoutSelect.addEventListener('change', loadWorkout);
        ui.saveWorkoutBtn.addEventListener('click', saveWorkout);
        ui.deleteWorkoutBtn.addEventListener('click', deleteWorkout);
        ui.voiceSelect.addEventListener('click', function() {
            currentVoiceIdx = ui.voiceSelect.selectedIndex;
        });

        addExercise('Jumping Jacks', 30);
        addExercise('Wall Sit', 30);
        addExercise('Push ups', 30);
        addExercise('Crunches', 30);
        addExercise('Step ups', 30);
        addExercise('Squats', 30);
        addExercise('Triceps Dips', 30);
        addExercise('Plank', 30);
        addExercise('High Knees Running In Place', 30);
        addExercise('Lunge', 30);
        addExercise('Push up and Rotation', 30);
        addExercise('Side Plank', 30);

    </script>
</body>
</html>
